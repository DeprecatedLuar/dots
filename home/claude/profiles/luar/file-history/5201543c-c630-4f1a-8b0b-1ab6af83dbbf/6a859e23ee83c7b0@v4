#!/bin/bash

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

error() { echo -e "${RED}→ $1${NC}" >&2; exit 1; }
success() { echo -e "${GREEN}→ $1${NC}"; }
info() { echo -e "${BLUE}→ $1${NC}"; }

# Paths
TOOL_DIR="$HOME/.config/ireallylovemydots"
BIN_DIR="$HOME/.local/bin"
DOTS_DIR="$HOME/.config/dots"

# Check if running from correct location
if [[ ! -f "$(dirname "$0")/bin/dots" ]]; then
    error "install.sh must be run from the ireallylovemydots directory"
fi

# Create directories
mkdir -p "$BIN_DIR"

# Copy tool to ~/.config/ireallylovemydots
info "Installing tool to $TOOL_DIR..."
mkdir -p "$TOOL_DIR"
cp -r "$(dirname "$0")"/* "$TOOL_DIR/"
chmod +x "$TOOL_DIR/bin/dots"

# Symlink binary to PATH
info "Creating symlink: $BIN_DIR/dots -> $TOOL_DIR/bin/dots"
ln -sf "$TOOL_DIR/bin/dots" "$BIN_DIR/dots"

# Install completions
if [[ -f /usr/share/bash-completion/bash_completion ]] || [[ -f /etc/bash_completion ]]; then
    COMPLETION_DIR="$HOME/.local/share/bash-completion/completions"
    mkdir -p "$COMPLETION_DIR"
    info "Installing completions to $COMPLETION_DIR/dots"
    ln -sf "$TOOL_DIR/lib/completions.sh" "$COMPLETION_DIR/dots"
    success "Completions installed (reload shell to activate)"
else
    info "bash-completion not detected"
    echo "To enable tab completions, add to ~/.bashrc:"
    echo "  source $TOOL_DIR/lib/completions.sh"
fi

# Initialize dots repo if doesn't exist
if [[ ! -d "$DOTS_DIR" ]]; then
    info "Initializing dotfiles repository at $DOTS_DIR..."
    mkdir -p "$DOTS_DIR"
    cd "$DOTS_DIR"
    git init
    mkdir -p config home
    success "Created dotfiles repo at $DOTS_DIR"
else
    info "Dotfiles repo already exists at $DOTS_DIR"
fi

echo ""
success "dots installed successfully!"

# Check if ~/.local/bin is in PATH
if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
    echo ""
    warn "~/.local/bin is not in your PATH"
    echo "Add this to your ~/.bashrc or ~/.bash_profile:"
    echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
fi

echo ""
echo "Next steps:"
echo "  1. Reload your shell or run: source ~/.bashrc"
echo "  2. Run: dots setup <username/repo> to connect your GitHub"
echo "  3. Start managing your dotfiles with: dots snatch <config>"
echo ""
