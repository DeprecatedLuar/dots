  source "$(dirname "$0")/../lib/utils.sh"
  source "$(dirname "$0")/../lib/commands.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

error() { echo -e "${RED}→ $1${NC}" >&2; exit 1; }
success() { echo -e "${GREEN}→ $1${NC}"; }
warn() { echo -e "${YELLOW}! $1${NC}"; }
info() { echo -e "${BLUE}→ $1${NC}"; }

check_dotfiles_repo() {
    [[ -d "$DOTFILES/.git" ]] || error "Dots repo not found at $DOTFILES\nRun 'bashrc init dots' first"
}

ensure_dotfiles_structure() {
    mkdir -p "$DOTFILES/config"
    mkdir -p "$DOTFILES/home"
}

# Strip leading dot from name (e.g., .nvim -> nvim)
strip_dot() {
    local name="$1"
    echo "${name#.}"
}

# Find where a config currently lives in the filesystem
# Returns: "config:nvim" or "home:.gitconfig" or "none"
find_in_filesystem() {
    local name="$1"
    local stripped=$(strip_dot "$name")

    # Check .config first (without dot) - include broken symlinks
    if [[ -e "$HOME/.config/$stripped" ]] || [[ -L "$HOME/.config/$stripped" ]]; then
        echo "config:$stripped"
        return
    fi

    # Check home (try with original name, then stripped) - include broken symlinks
    if [[ -e "$HOME/$name" ]] || [[ -L "$HOME/$name" ]]; then
        echo "home:$name"
        return
    fi

    if [[ "$name" != "$stripped" ]] && ([[ -e "$HOME/$stripped" ]] || [[ -L "$HOME/$stripped" ]]); then
        echo "home:$stripped"
        return
    fi

    echo "none"
}

# Check if a config exists in dots repo
# Returns: "config:nvim" or "home:.gitconfig" or "none"
find_in_dotfiles() {
    local name="$1"
    local stripped=$(strip_dot "$name")

    # Check both with and without dots
    if [[ -e "$DOTFILES/config/$stripped" ]]; then
        echo "config:$stripped"
        return
    fi

    if [[ -e "$DOTFILES/config/$name" ]]; then
        echo "config:$name"
        return
    fi

    if [[ -e "$DOTFILES/home/$name" ]]; then
        echo "home:$name"
        return
    fi

    if [[ -e "$DOTFILES/home/$stripped" ]]; then
        echo "home:$stripped"
        return
    fi

    echo "none"
}
