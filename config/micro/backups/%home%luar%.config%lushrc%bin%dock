#!/usr/bin/env bash

DEFAULT_HOST="nuremberg"
DOCK_DIR="/tmp/dock"

INPUT="${1:-$DEFAULT_HOST}"
VPS_PATH="${2:-~}"

# Parse user@host syntax for direct connections
if [[ "$INPUT" == *@* ]]; then
  SSH_USER="${INPUT%%@*}"
  VPS_HOST="${INPUT#*@}"
  VPS_NAME="$VPS_HOST"
  DIRECT_CONNECTION=true
else
  VPS_NAME="$INPUT"
  VPS_HOST="$INPUT"
  SSH_USER=$(ssh -G "$VPS_NAME" 2>/dev/null | awk '/^user / {print $2}')
  if [ -z "$SSH_USER" ]; then
    echo "Error: Could not find SSH config for '$VPS_NAME'"
        echo "For direct connections, use: dock user@host [path]"
        exit 1
    fi
    DIRECT_CONNECTION=false
fi

if [[ "$VPS_PATH" == ~* ]]; then
    VPS_PATH="/home/$SSH_USER${VPS_PATH#\~}"
elif [[ "$VPS_PATH" != /* ]]; then
    VPS_PATH="/home/$SSH_USER/$VPS_PATH"
fi

MOUNT_POINT="$DOCK_DIR/$VPS_NAME"
SYMLINK="$HOME/$VPS_NAME"

# Check if already mounted
if mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
    echo "$VPS_NAME already docked at ~/$VPS_NAME"
    exit 0
fi

# Clean up stale symlink if exists
if [ -L "$SYMLINK" ] && [ ! -e "$SYMLINK" ]; then
    rm "$SYMLINK"
fi

# Check for conflicts
if [ -e "$SYMLINK" ] && [ ! -L "$SYMLINK" ]; then
    echo "Error: ~/$VPS_NAME exists and is not a symlink"
    exit 1
fi

mkdir -p "$DOCK_DIR" "$MOUNT_POINT"

if $DIRECT_CONNECTION; then
    SSH_TARGET="$SSH_USER@$VPS_HOST"
else
    SSH_TARGET="$VPS_NAME"
fi

printf "Docking %s" "$VPS_NAME"

# Check path exists, fallback to /
ssh "$SSH_TARGET" "test -d '$VPS_PATH'" 2>/dev/null &
CHECK_PID=$!
DOTS=""
while kill -0 $CHECK_PID 2>/dev/null; do
    printf "\rDocking %s%-3s" "$VPS_NAME" "$DOTS"
    DOTS="${DOTS}."
    [ ${#DOTS} -gt 3 ] && DOTS=""
    sleep 0.3
done
wait $CHECK_PID || VPS_PATH="/"

sshfs "$SSH_TARGET:$VPS_PATH" "$MOUNT_POINT" \
    -o reconnect,ServerAliveInterval=15,ServerAliveCountMax=3 \
    -o follow_symlinks,auto_cache,idmap=user &

SSHFS_PID=$!
while kill -0 $SSHFS_PID 2>/dev/null; do
    printf "\rDocking %s%-3s" "$VPS_NAME" "$DOTS"
    DOTS="${DOTS}."
    [ ${#DOTS} -gt 3 ] && DOTS=""
    sleep 0.3
done
wait $SSHFS_PID
SSHFS_EXIT=$?

if mountpoint -q "$MOUNT_POINT" && [ $SSHFS_EXIT -eq 0 ]; then
    ln -sfn "$MOUNT_POINT" "$SYMLINK"
    printf "\r%s docked at ~/%s\n" "$VPS_NAME" "$VPS_NAME"
else
    printf "\rDocking %s failed\n" "$VPS_NAME"
    rmdir "$MOUNT_POINT" 2>/dev/null
    exit 1
fi
